---
title: Diversity calculation (Beta)
author: Masatoshi Katabuchi
date: "2021/11/10"
output:
#rmdformats::material
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
      toc: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      cache=TRUE,
                      message=FALSE)

htmltools::tagList(rmarkdown::html_dependency_font_awesome())
```

<a href="https://twitter.com/mattocci"><i class="fa fa-twitter fa-1x"></i> Twittter</a>
<a href="https://github.com/mattocci27/"><i class="fa fa-github fa-1x"></i> Github</a>
<a href="mailto:mattocci27@gmail.com"><i class="fa fa-envelope fa-1x"></i> Email</a>

# Data

```{r}
library(picante)
library(FD)
library(tidyverse)
library(rmarkdown)
library(betapart)
library(BAT)
```

# Data

## Community

```{r}
d <- read_csv("data/samp.csv")
d
```

```{r}
samp <- tapply(d$abund, list(d$Site, d$Species), sum)
samp
class(samp)
```

## Phylogeny

```{r, fig.height = 20}
phylo <- read.tree("./data/dummy_tree.newick")
plot(phylo)
```

## Traits

| Abbreviation | Trait                                      | Unit              |
| ------------ | ------------------------------------------ | ----------------- |
| LMA          | Leaf mass per area                         | g m^-2^           |
| LL           | Leaf lifespans (longevity)                 | months            |
| Amass        | Maximum photosynthetic rates per unit mass | nnoml g^-1^ s^-^1 |
| Rmass        | Dark respiration rates per unit mass       | nnoml g^-1^ s^-^1 |
| Nmass        | Leaf nitrogen per unit mass                | %                 |
| Pmass        | Leaf phosphorus per unit mass              | %                 |
| WD           | Wood density                               | g cm^-3^          |
| SM           | Seed dry mass                              | mg                |

```{r}

trait <- read_csv("./data/dummy_trait.csv")

trait2 <- trait |>
  mutate(logLMA = log(LMA),
         logLL = log(LL),
         logAmass = log(Amass),
         logRmass = log(Rmass),
         logNmass = log(Nmass),
         logPmass = log(Pmass),
         logSM = log(SM)) |>
  dplyr::select(sp, logLMA, logLL, logAmass, logRmass, logNmass, logPmass, WD, logSM)
```

# Beta

```{r}
library(BAT)
comm <- matrix(c(2,2,0,0,0,1,1,0,0,0,0,2,2,0,0,0,0,1,2,2), nrow = 4, ncol = 5, byrow = TRUE)
tree <- hclust(dist(c(1:5), method="euclidean"), method="average")
beta(comm)
beta(comm, abund = FALSE, comp = TRUE)
beta(comm, tree)
```


```{r}
# toy tree for 6 species (sp1 to sp6)
require(ape)
toy.tree<-read.tree(text="(((sp1:1,sp2:1):5,(sp3:3,sp4:3):3):2,(sp5:7,sp6:7):1);")
plot(toy.tree)
# toy community table with 6 assemblages (A to F) with 6 species (sp1 to sp6)
toy.comm<-matrix(nrow=6, ncol=6)
rownames(toy.comm)<-c("A","B","C","D","E","F")
colnames(toy.comm)<-c("sp1","sp2","sp3","sp4","sp5","sp6")
toy.comm[1,]<-c(1,1,1,0,0,0)
toy.comm[2,]<-c(0,1,1,1,0,0)
toy.comm[3,]<-c(0,0,1,1,1,0)
toy.comm[4,]<-c(0,0,1,1,1,1)
toy.comm[5,]<-c(0,0,0,1,1,1)
toy.comm[6,]<-c(1,0,0,1,1,1)
toy.phylobetamulti<-betapart::phylo.beta.multi(toy.comm, toy.tree, index.family="sor")
toy.betamulti<-beta.multi(toy.comm, index.family="sor")


phylo.beta.pair(toy.comm, toy.tree, index.family="sor")
```


```{r}
my_glm <- function(x){
  glm(x ~ habit, binomial)
}


habit <- rnorm(5)
res <- apply(samp, 2, function(x)glm(x ~ habit, poisson))
```
